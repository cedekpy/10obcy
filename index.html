<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogoLobby - Czat z Grami</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 30px; width: 100%; max-width: 800px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .screen { display: none; }
        .active { display: block; }
        h1 { text-align: center; margin-bottom: 20px; color: #333; font-size: 2.5em; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { text-align: center; margin-bottom: 20px; color: #666; font-size: 1.2em; }
        
        .btn { padding: 15px 25px; border: none; border-radius: 12px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; margin: 10px 0; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: linear-gradient(45deg, #6c757d, #495057); }
        .btn-success { background: linear-gradient(45deg, #28a745, #20c997); }
        .btn-danger { background: linear-gradient(45deg, #dc3545, #e83e8c); }
        .btn-warning { background: linear-gradient(45deg, #ffc107, #fd7e14); color: #000; }
        
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .feature-card { background: #f8f9fa; padding: 25px; border-radius: 15px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .feature-card:hover { transform: translateY(-5px); border-color: #667eea; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .feature-icon { font-size: 3em; margin-bottom: 15px; }
        
        .chat-container { height: 400px; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin: 20px 0; overflow-y: auto; background: #f8f9fa; }
        .message { margin: 12px 0; padding: 12px; border-radius: 12px; max-width: 70%; word-wrap: break-word; position: relative; }
        .message.own { background: linear-gradient(45deg, #667eea, #764ba2); color: white; margin-left: auto; text-align: right; }
        .message.other { background: white; border: 2px solid #e9ecef; }
        .message.system { background: #e9ecef; color: #6c757d; text-align: center; margin: 8px auto; max-width: 90%; font-size: 13px; }
        
        .message-img { max-width: 250px; max-height: 250px; border-radius: 10px; margin-top: 8px; cursor: pointer; border: 2px solid #e9ecef; }
        .message-reply { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #fff; }
        
        .reactions { display: flex; gap: 5px; margin-top: 8px; flex-wrap: wrap; }
        .reaction { background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 12px; cursor: pointer; }
        
        .status { padding: 15px; border-radius: 12px; text-align: center; margin: 15px 0; background: linear-gradient(45deg, #d1ecf1, #bee5eb); color: #0c5460; }
        
        .input-group { display: flex; gap: 12px; margin: 20px 0; }
        .message-input { flex: 1; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 16px; }
        
        /* Lobby styles */
        .lobby-section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; }
        .lobby-buttons { display: flex; gap: 15px; margin: 20px 0; }
        .lobby-btn { flex: 1; padding: 20px; border: 2px solid #e9ecef; border-radius: 15px; background: #f8f9fa; cursor: pointer; text-align: center; transition: all 0.3s; }
        .lobby-btn:hover { border-color: #28a745; transform: translateY(-2px); }
        .input-group-lobby { display: flex; gap: 12px; margin: 15px 0; }
        .code-input { flex: 1; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; text-align: center; font-size: 20px; letter-spacing: 3px; font-weight: bold; }
        .code-display { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; text-align: center; margin: 20px 0; font-size: 28px; letter-spacing: 4px; font-weight: bold; }
        .lobby-info { background: #e9ecef; padding: 15px; border-radius: 12px; margin: 15px 0; text-align: center; }
        .users-list { margin: 15px 0; }
        .user-item { padding: 12px; background: #f8f9fa; margin: 8px 0; border-radius: 10px; display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(45deg, #667eea, #764ba2); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
        
        .chat-actions { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .action-btn { padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; background: #f8f9fa; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .action-btn:hover { border-color: #667eea; background: #667eea; color: white; }
        
        .emoticon-panel { background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 15px; margin: 10px 0; display: none; position: absolute; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .emoticon-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; max-height: 200px; overflow-y: auto; }
        .emoticon { font-size: 24px; cursor: pointer; padding: 5px; text-align: center; border-radius: 5px; }
        .emoticon:hover { background: #f8f9fa; }
        
        .games-panel { background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; margin: 15px 0; }
        .game-card { background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 10px 0; cursor: pointer; border: 2px solid transparent; transition: all 0.3s; }
        .game-card:hover { border-color: #667eea; transform: translateY(-2px); }
        
        .typing-indicator { color: #6c757d; font-style: italic; font-size: 13px; margin: 8px 0; display: none; }
        
        .reply-indicator { background: #e9ecef; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; display: none; }
        .reply-close { float: right; cursor: pointer; font-weight: bold; }
        
        .file-input { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ekran g≈Ç√≥wny -->
        <div id="screenMain" class="screen active">
            <h1>üéÆ LogoLobby</h1>
            <h2>Wybierz co chcesz robiƒá</h2>
            
            <div class="main-grid">
                <div class="feature-card" onclick="showScreen('screenCreateLobby')">
                    <div class="feature-icon">üé™</div>
                    <h3>Stw√≥rz Lobby</h3>
                    <p>Utw√≥rz prywatny pok√≥j czatu dla znajomych</p>
                </div>
                <div class="feature-card" onclick="showScreen('screenJoinLobby')">
                    <div class="feature-icon">üîó</div>
                    <h3>Do≈ÇƒÖcz do Lobby</h3>
                    <p>Do≈ÇƒÖcz do istniejƒÖcego lobby z kodem</p>
                </div>
                <div class="feature-card" onclick="showGamesPanel()">
                    <div class="feature-icon">üé≤</div>
                    <h3>Gry Multiplayer</h3>
                    <p>Zagraj w gry z innymi u≈ºytkownikami</p>
                </div>
                <div class="feature-card" onclick="showEmoticonPanel()">
                    <div class="feature-icon">üòä</div>
                    <h3>Emotikony</h3>
                    <p>Du≈ºy wyb√≥r emotek i reakcji</p>
                </div>
            </div>
        </div>

        <!-- Ekran tworzenia lobby -->
        <div id="screenCreateLobby" class="screen">
            <h1>üé™ Stw√≥rz Lobby</h1>
            <div class="input-group">
                <input type="text" id="nickInput" class="message-input" placeholder="Tw√≥j nick" maxlength="20">
            </div>
            <button id="createLobbyBtn" class="btn btn-success">üéÆ UTWORZ LOBBY</button>
            
            <div id="lobbyCreated" style="display: none;">
                <div class="code-display" id="lobbyCodeDisplay"></div>
                <div class="lobby-info">
                    <p>üéâ Lobby utworzone! Udostƒôpnij ten kod znajomym!</p>
                    <p>üë• Oczekiwanie na graczy...</p>
                </div>
                <div class="users-list" id="lobbyUsersList"></div>
                <button class="btn btn-warning" onclick="startLobbyChat()">üí¨ Rozpocznij Czat</button>
                <button class="btn btn-secondary" onclick="leaveLobby()">üö™ Opu≈õƒá lobby</button>
            </div>
            
            <button class="btn btn-secondary" onclick="showScreen('screenMain')">üîô Powr√≥t</button>
        </div>

        <!-- Ekran do≈ÇƒÖczania do lobby -->
        <div id="screenJoinLobby" class="screen">
            <h1>üîó Do≈ÇƒÖcz do Lobby</h1>
            <div class="input-group">
                <input type="text" id="joinNickInput" class="message-input" placeholder="Tw√≥j nick" maxlength="20">
            </div>
            <div class="input-group-lobby">
                <input type="text" id="lobbyCodeInput" class="code-input" placeholder="WPISZ KOD" maxlength="6">
            </div>
            <button id="joinLobbyBtn" class="btn btn-success">üéØ DO≈ÅƒÑCZ DO LOBBY</button>
            <button class="btn btn-secondary" onclick="showScreen('screenMain')">üîô Powr√≥t</button>
        </div>

        <!-- Ekran czatu w lobby -->
        <div id="screenLobbyChat" class="screen">
            <h1>üí¨ LogoLobby: <span id="lobbyName"></span></h1>
            <div class="status">
                ‚úÖ Po≈ÇƒÖczono z lobby! 
                <span id="onlinePlayers">1</span> graczy online
            </div>
            
            <div class="chat-actions">
                <button class="action-btn" onclick="document.getElementById('fileInput').click()">üì∑ Zdjƒôcie</button>
                <button class="action-btn" onclick="toggleEmoticonPanel()">üòä Emotki</button>
                <button class="action-btn" onclick="toggleGamesPanel()">üéÆ Gry</button>
                <button class="action-btn" onclick="sendReaction('üëç')">üëç</button>
                <button class="action-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="action-btn" onclick="sendReaction('üòÇ')">üòÇ</button>
                <button class="action-btn" onclick="sendReaction('üî•')">üî•</button>
            </div>
            
            <div id="emoticonPanel" class="emoticon-panel">
                <div class="emoticon-grid" id="emoticonGrid"></div>
            </div>
            
            <div id="gamesPanel" class="games-panel" style="display: none;">
                <h3>üé≤ Wybierz grƒô</h3>
                <div class="game-card" onclick="startGame('ticTacToe')">
                    <h4>‚≠ï K√≥≈Çko i Krzy≈ºyk</h4>
                    <p>Klasyczna gra dla 2 graczy</p>
                </div>
                <div class="game-card" onclick="startGame('quiz')">
                    <h4>‚ùì Quiz</h4>
                    <p>Konkurs wiedzy dla wszystkich</p>
                </div>
                <div class="game-card" onclick="startGame('wordGame')">
                    <h4>üî§ Gra w S≈Çowa</h4>
                    <p>Tw√≥rz s≈Çowa na czas</p>
                </div>
            </div>
            
            <div class="reply-indicator" id="replyIndicator">
                <span id="replyText"></span>
                <span class="reply-close" onclick="cancelReply()">‚úï</span>
            </div>
            
            <div class="chat-container" id="lobbyChatMessages"></div>
            
            <div class="typing-indicator" id="typingIndicator">
                <span id="typingUsers"></span> pisze...
            </div>
            
            <div class="input-group">
                <input type="text" id="lobbyMessageInput" class="message-input" placeholder="Napisz wiadomo≈õƒá..." maxlength="500">
                <button id="sendLobbyBtn" class="btn">üì§ Wy≈õlij</button>
            </div>
            
            <input type="file" id="fileInput" class="file-input" accept="image/*">
            
            <button class="btn btn-danger" onclick="leaveLobby()">üö™ Opu≈õƒá Czat</button>
        </div>
    </div>

    <script>
        // Konfiguracja Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBMM3ohzmnyBmjvcFqIOaapHzu02GFm0Hw",
            authDomain: "obcy-44426.firebaseapp.com",
            projectId: "obcy-44426",
            storageBucket: "obcy-44426.firebasestorage.app",
            messagingSenderId: "270864436948",
            appId: "1:270864436948:web:7771583aeb50dfb3c4f541",
            measurementId: "G-0JEEMG64JN"
        };

        // Inicjalizacja Firebase
        let db, auth, storage;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            storage = firebase.storage();
            console.log('üî• Firebase zainicjalizowany!');
        } catch (error) {
            console.error('‚ùå B≈ÇƒÖd Firebase:', error);
        }

        let currentUser = null;
        let currentLobby = null;
        let lobbyListener = null;
        let userNick = '';
        let typingTimer = null;
        let replyingTo = null;
        let currentGame = null;

        // Bank emotikonek
        const emoticons = [
            'üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö',
            'üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£',
            'üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó',
            'ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê',
            'ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üòà','üëø','üëπ','üë∫','ü§°','üí©','üëª','üíÄ','‚ò†Ô∏è','üëΩ','üëæ',
            'ü§ñ','üéÉ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ','üôà','üôâ','üôä','üíå','üíò','üíù','üíñ','üíó','üíì',
            'üíû','üíï','üíü','‚ù£Ô∏è','üíî','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','üíã','üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§å',
            'ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå',
            'üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü¶∑','ü¶¥','üëÄ','üëÅÔ∏è',
            'üëÖ','üëÑ','üíã','üé∂','üéµ','üî•','üíØ','üöÄ','‚≠ê','üåü','üåÄ','üåà','üåä','‚ú®','üéâ','üéä','üéÅ','üéà','üéÄ','üèÜ',
            'ü•á','ü•à','ü•â','‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','üèâ','üé±','ü™Ä','üèì','üëª','ü¶Ñ','üê∂','üê±','üê≠','üêπ','üê∞',
            'ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üêΩ','üê∏','üêµ','üôà','üôâ','üôä','üéÆ','üëæ','üïπÔ∏è','üé≤','‚ô†Ô∏è','‚ô•Ô∏è',
            '‚ô¶Ô∏è','‚ô£Ô∏è','üÉè','üÄÑ','üé¥','üîá','üîà','üîâ','üîä','üì¢','üì£','üìØ','üîî','üéº','üéµ','üé∂','üèß','üöÆ','üö∞','‚ôø',
            'üöπ','üö∫','üöª','üöº','üöæ','üõÇ','üõÉ','üõÑ','üõÖ','‚ö†Ô∏è','üö∏','‚õî','üö´','üö≥','üö≠','üöØ','üö±','üö∑','üìµ','üîû',
            '‚ò¢Ô∏è','‚ò£Ô∏è','‚¨ÜÔ∏è','‚ÜóÔ∏è','‚û°Ô∏è','‚ÜòÔ∏è','‚¨áÔ∏è','‚ÜôÔ∏è','‚¨ÖÔ∏è','‚ÜñÔ∏è','‚ÜïÔ∏è','‚ÜîÔ∏è','‚Ü©Ô∏è','‚Ü™Ô∏è','‚§¥Ô∏è','‚§µÔ∏è','üîÉ','üîÑ','üîô','üîö',
            'üîõ','üîú','üîù','üõê','‚öõÔ∏è','üïâÔ∏è','‚ú°Ô∏è','‚ò∏Ô∏è','‚òØÔ∏è','‚úùÔ∏è','‚ò¶Ô∏è','‚ò™Ô∏è','‚òÆÔ∏è','üïé','üîØ','‚ôà','‚ôâ','‚ôä','‚ôã','‚ôå',
            '‚ôç','‚ôé','‚ôè','‚ôê','‚ôë','‚ôí','‚ôì','‚õé','üîÄ','üîÅ','üîÇ','‚ñ∂Ô∏è','‚è©','‚è≠Ô∏è','‚èØÔ∏è','‚óÄÔ∏è','‚è™','‚èÆÔ∏è','üîº','‚è´','üîΩ',
            '‚è¨','‚è∏Ô∏è','‚èπÔ∏è','‚è∫Ô∏è','‚èèÔ∏è','üé¶','üîÖ','üîÜ','üì∂','üì≥','üì¥','‚ôÄÔ∏è','‚ôÇÔ∏è','‚ößÔ∏è','‚úñÔ∏è','‚ûï','‚ûñ','‚ûó','‚ôæÔ∏è','‚ÄºÔ∏è',
            '‚ÅâÔ∏è','‚ùì','‚ùî','‚ùï','‚ùó','„Ä∞Ô∏è','üí±','üí≤','‚öïÔ∏è','‚ôªÔ∏è','‚öúÔ∏è','üî±','üìõ','üî∞','‚≠ï','‚úÖ','‚òëÔ∏è','‚úîÔ∏è','‚ùå','‚ùé',
            '‚û∞','‚ûø','„ÄΩÔ∏è','‚ú≥Ô∏è','‚ú¥Ô∏è','‚ùáÔ∏è','¬©Ô∏è','¬ÆÔ∏è','‚Ñ¢Ô∏è','#Ô∏è‚É£','*Ô∏è‚É£','0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£',
            '9Ô∏è‚É£','üîü','üî†','üî°','üî¢','üî£','üî§','üÖ∞Ô∏è','üÜé','üÖ±Ô∏è','üÜë','üÜí','üÜì','‚ÑπÔ∏è','üÜî','‚ìÇÔ∏è','üÜï','üÜñ','üÖæÔ∏è',
            'üÜó','üÖøÔ∏è','üÜò','üÜô','üÜö','üàÅ','üàÇÔ∏è','üà∑Ô∏è','üà∂','üàØ','üâê','üàπ','üàö','üà≤','üâë','üà∏','üà¥','üà≥','„äóÔ∏è',
            '„äôÔ∏è','üà∫','üàµ','‚ñ™Ô∏è','‚ñ´Ô∏è','‚óªÔ∏è','‚óºÔ∏è','‚óΩ','‚óæ','‚¨õ','‚¨ú','üî∂','üî∑','üî∏','üîπ','üî∫','üîª','üí†','üîò',
            'üî≥','üî≤','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö','üïõ','üïú','üïù','üïû','üïü','üï†','üï°',
            'üï¢','üï£','üï§','üï•','üï¶','üïß'
        ];

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM za≈Çadowany');
            initAuth();
            setupEvents();
            initEmoticons();
        });

        function initAuth() {
            console.log('Inicjalizacja auth...');
            auth.signInAnonymously()
                .then(user => {
                    currentUser = user.user;
                    console.log('‚úÖ Zalogowano:', currentUser.uid);
                })
                .catch(error => {
                    console.error('‚ùå B≈ÇƒÖd logowania:', error);
                });
        }

        function setupEvents() {
            // Lobby events
            document.getElementById('createLobbyBtn').addEventListener('click', createLobby);
            document.getElementById('joinLobbyBtn').addEventListener('click', joinLobby);
            document.getElementById('sendLobbyBtn').addEventListener('click', sendLobbyMessage);
            
            // Enter key events
            document.getElementById('lobbyMessageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendLobbyMessage();
                }
            });
            
            // Typing indicator
            document.getElementById('lobbyMessageInput').addEventListener('input', function() {
                updateTypingStatus(true);
            });
            
            // File upload
            document.getElementById('fileInput').addEventListener('change', handleImageUpload);

            console.log('Eventy ustawione!');
        }

        function initEmoticons() {
            const grid = document.getElementById('emoticonGrid');
            emoticons.forEach(emoji => {
                const emojiEl = document.createElement('div');
                emojiEl.className = 'emoticon';
                emojiEl.textContent = emoji;
                emojiEl.onclick = () => {
                    document.getElementById('lobbyMessageInput').value += emoji;
                    toggleEmoticonPanel();
                };
                grid.appendChild(emojiEl);
            });
        }

        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenName).classList.add('active');
        }

        function showEmoticonPanel() {
            showScreen('screenLobbyChat');
            setTimeout(() => {
                toggleEmoticonPanel();
            }, 100);
        }

        function showGamesPanel() {
            showScreen('screenLobbyChat');
            setTimeout(() => {
                toggleGamesPanel();
            }, 100);
        }

        function toggleEmoticonPanel() {
            const panel = document.getElementById('emoticonPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            document.getElementById('gamesPanel').style.display = 'none';
        }

        function toggleGamesPanel() {
            const panel = document.getElementById('gamesPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            document.getElementById('emoticonPanel').style.display = 'none';
        }

        // LOBBY SYSTEM
        function generateLobbyCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function createLobby() {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) {
                alert('Podaj sw√≥j nick!');
                return;
            }

            userNick = nick;
            const lobbyCode = generateLobbyCode();

            try {
                await db.collection('lobbies').doc(lobbyCode).set({
                    code: lobbyCode,
                    createdBy: currentUser.uid,
                    createdAt: new Date(),
                    users: [{
                        uid: currentUser.uid,
                        nick: nick,
                        joinedAt: new Date(),
                        isOnline: true
                    }],
                    messages: [],
                    reactions: {},
                    settings: {
                        maxUsers: 10,
                        isActive: true
                    }
                });

                currentLobby = lobbyCode;
                
                document.getElementById('lobbyCodeDisplay').textContent = lobbyCode;
                document.getElementById('lobbyCreated').style.display = 'block';
                document.getElementById('createLobbyBtn').style.display = 'none';
                document.getElementById('nickInput').style.display = 'none';
                
                listenToLobby(lobbyCode);
                updateUsersList([{uid: currentUser.uid, nick: nick}]);
                
            } catch (error) {
                console.error('B≈ÇƒÖd tworzenia lobby:', error);
                alert('B≈ÇƒÖd tworzenia lobby: ' + error.message);
            }
        }

        async function joinLobby() {
            const nick = document.getElementById('joinNickInput').value.trim();
            const code = document.getElementById('lobbyCodeInput').value.trim().toUpperCase();

            if (!nick) {
                alert('Podaj sw√≥j nick!');
                return;
            }
            if (!code) {
                alert('Podaj kod lobby!');
                return;
            }

            userNick = nick;

            try {
                const lobbyRef = db.collection('lobbies').doc(code);
                const lobbyDoc = await lobbyRef.get();

                if (!lobbyDoc.exists) {
                    alert('‚ùå Lobby o podanym kodzie nie istnieje!');
                    return;
                }

                const lobbyData = lobbyDoc.data();
                
                if (!lobbyData.settings.isActive) {
                    alert('‚ùå To lobby jest nieaktywne!');
                    return;
                }
                
                if (lobbyData.users.length >= lobbyData.settings.maxUsers) {
                    alert('‚ùå Lobby jest pe≈Çne!');
                    return;
                }
                
                // Sprawd≈∫ czy u≈ºytkownik ju≈º jest w lobby
                const userExists = lobbyData.users.some(user => user.uid === currentUser.uid);
                if (userExists) {
                    alert('‚ÑπÔ∏è Ju≈º jeste≈õ w tym lobby!');
                    startLobbyChat();
                    return;
                }
                
                // Dodaj u≈ºytkownika do lobby
                await lobbyRef.update({
                    users: firebase.firestore.FieldValue.arrayUnion({
                        uid: currentUser.uid,
                        nick: nick,
                        joinedAt: new Date(),
                        isOnline: true
                    })
                });

                currentLobby = code;
                startLobbyChat();
                
            } catch (error) {
                console.error('B≈ÇƒÖd do≈ÇƒÖczania do lobby:', error);
                alert('‚ùå B≈ÇƒÖd do≈ÇƒÖczania: ' + error.message);
            }
        }

        function startLobbyChat() {
            showScreen('screenLobbyChat');
            document.getElementById('lobbyName').textContent = currentLobby;
            listenToLobby(currentLobby);
            
            // Dodaj powitalnƒÖ wiadomo≈õƒá
            addSystemMessage(`üëã ${userNick} do≈ÇƒÖczy≈Ç do czatu!`);
        }

        function listenToLobby(lobbyCode) {
            lobbyListener = db.collection('lobbies').doc(lobbyCode)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const lobbyData = doc.data();
                        updateLobbyUI(lobbyData);
                    } else {
                        alert('‚ùå Lobby zosta≈Ço zamkniƒôte!');
                        leaveLobby();
                    }
                });
        }

        function updateLobbyUI(lobbyData) {
            updateUsersList(lobbyData.users || []);
            updateChatMessages(lobbyData.messages || [], lobbyData.reactions || {});
            
            const onlinePlayers = document.getElementById('onlinePlayers');
            if (onlinePlayers) {
                const onlineUsers = lobbyData.users.filter(user => user.isOnline).length;
                onlinePlayers.textContent = onlineUsers;
            }
            
            // Typing indicator
            const typingUsers = lobbyData.typingUsers || [];
            const otherTypingUsers = typingUsers.filter(uid => uid !== currentUser.uid);
            if (otherTypingUsers.length > 0) {
                const userNicks = otherTypingUsers.map(uid => {
                    const user = lobbyData.users.find(u => u.uid === uid);
                    return user ? user.nick : 'Kto≈õ';
                });
                document.getElementById('typingUsers').textContent = userNicks.join(', ');
                document.getElementById('typingIndicator').style.display = 'block';
            } else {
                document.getElementById('typingIndicator').style.display = 'none';
            }
        }

        function updateUsersList(users) {
            const usersList = document.getElementById('lobbyUsersList');
            if (usersList) {
                usersList.innerHTML = '';
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'user-avatar';
                    avatar.textContent = user.nick.charAt(0).toUpperCase();
                    
                    const userInfo = document.createElement('div');
                    userInfo.textContent = user.nick;
                    if (user.uid === currentUser.uid) {
                        userInfo.innerHTML += ' <strong>(Ty)</strong>';
                    }
                    
                    userItem.appendChild(avatar);
                    userItem.appendChild(userInfo);
                    usersList.appendChild(userItem);
                });
            }
        }

        function updateChatMessages(messages, reactions) {
            const chatContainer = document.getElementById('lobbyChatMessages');
            if (chatContainer) {
                chatContainer.innerHTML = '';
                messages.forEach((msg, index) => {
                    const messageDiv = document.createElement('div');
                    
                    if (msg.type === 'system') {
                        messageDiv.className = 'message system';
                        messageDiv.textContent = msg.text;
                    } else if (msg.type === 'image') {
                        messageDiv.className = `message ${msg.userId === currentUser.uid ? 'own' : 'other'}`;
                        
                        const sender = document.createElement('div');
                        sender.style.fontSize = '12px';
                        sender.style.marginBottom = '5px';
                        sender.textContent = msg.nick;
                        
                        const img = document.createElement('img');
                        img.src = msg.imageUrl;
                        img.className = 'message-img';
                        img.onclick = () => window.open(msg.imageUrl, '_blank');
                        
                        messageDiv.appendChild(sender);
                        messageDiv.appendChild(img);
                    } else {
                        messageDiv.className = `message ${msg.userId === currentUser.uid ? 'own' : 'other'}`;
                        
                        let messageContent = `<strong>${msg.nick}:</strong> `;
                        
                        if (msg.replyTo) {
                            const repliedMsg = messages.find(m => m.id === msg.replyTo);
                            if (repliedMsg) {
                                messageContent = `<div class="message-reply"><strong>${repliedMsg.nick}:</strong> ${repliedMsg.text}</div>` + messageContent + msg.text;
                            }
                        } else {
                            messageContent += msg.text;
                        }
                        
                        messageDiv.innerHTML = messageContent;
                        
                        // Dodaj mo≈ºliwo≈õƒá odpowiedzi
                        messageDiv.style.cursor = 'pointer';
                        messageDiv.onclick = () => {
                            if (msg.userId !== currentUser.uid) {
                                setReplyTo(msg.id, msg.nick, msg.text);
                            }
                        };
                    }
                    
                    // Dodaj reakcje
                    const messageReactions = reactions[msg.id] || {};
                    if (Object.keys(messageReactions).length > 0) {
                        const reactionsDiv = document.createElement('div');
                        reactionsDiv.className = 'reactions';
                        
                        Object.entries(messageReactions).forEach(([emoji, users]) => {
                            const reactionDiv = document.createElement('div');
                            reactionDiv.className = 'reaction';
                            reactionDiv.textContent = `${emoji} ${users.length}`;
                            reactionDiv.onclick = (e) => {
                                e.stopPropagation();
                                addReaction(msg.id, emoji);
                            };
                            reactionsDiv.appendChild(reactionDiv);
                        });
                        
                        messageDiv.appendChild(reactionsDiv);
                    }
                    
                    chatContainer.appendChild(messageDiv);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        async function sendLobbyMessage() {
            const input = document.getElementById('lobbyMessageInput');
            const text = input.value.trim();
            
            if (!text || !currentLobby) return;

            try {
                const lobbyRef = db.collection('lobbies').doc(currentLobby);
                const lobbyDoc = await lobbyRef.get();
                
                if (lobbyDoc.exists) {
                    const messages = lobbyDoc.data().messages || [];
                    const messageId = Date.now().toString();
                    
                    const newMessage = {
                        id: messageId,
                        userId: currentUser.uid,
                        nick: userNick,
                        text: text,
                        timestamp: new Date(),
                        type: 'text'
                    };
                    
                    if (replyingTo) {
                        newMessage.replyTo = replyingTo.id;
                    }
                    
                    messages.push(newMessage);

                    await lobbyRef.update({
                        messages: messages
                    });

                    input.value = '';
                    updateTypingStatus(false);
                    cancelReply();
                }
            } catch (error) {
                console.error('B≈ÇƒÖd wysy≈Çania wiadomo≈õci:', error);
            }
        }

        function setReplyTo(messageId, nick, text) {
            replyingTo = { id: messageId, nick: nick, text: text };
            document.getElementById('replyText').textContent = `Odpowiadasz na: ${nick}: ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}`;
            document.getElementById('replyIndicator').style.display = 'block';
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById('replyIndicator').style.display = 'none';
        }

        async function sendReaction(emoji) {
            if (!currentLobby) return;

            try {
                const input = document.getElementById('lobbyMessageInput');
                if (input.value.trim() === '') {
                    input.value = emoji;
                    sendLobbyMessage();
                } else {
                    input.value += emoji;
                }
            } catch (error) {
                console.error('B≈ÇƒÖd wysy≈Çania reakcji:', error);
            }
        }

        async function addReaction(messageId, emoji) {
            if (!currentLobby) return;

            try {
                const lobbyRef = db.collection('lobbies').doc(currentLobby);
                const lobbyDoc = await lobbyRef.get();
                
                if (lobbyDoc.exists) {
                    const reactions = lobbyDoc.data().reactions || {};
                    if (!reactions[messageId]) {
                        reactions[messageId] = {};
                    }
                    if (!reactions[messageId][emoji]) {
                        reactions[messageId][emoji] = [];
                    }
                    
                    if (!reactions[messageId][emoji].includes(currentUser.uid)) {
                        reactions[messageId][emoji].push(currentUser.uid);
                    } else {
                        // Usu≈Ñ reakcjƒô je≈õli ju≈º istnieje
                        reactions[messageId][emoji] = reactions[messageId][emoji].filter(uid => uid !== currentUser.uid);
                        if (reactions[messageId][emoji].length === 0) {
                            delete reactions[messageId][emoji];
                        }
                        if (Object.keys(reactions[messageId]).length === 0) {
                            delete reactions[messageId];
                        }
                    }
                    
                    await lobbyRef.update({
                        reactions: reactions
                    });
                }
            } catch (error) {
                console.error('B≈ÇƒÖd dodawania reakcji:', error);
            }
        }

        async function updateTypingStatus(isTyping) {
            if (!currentLobby) return;

            try {
                const lobbyRef = db.collection('lobbies').doc(currentLobby);
                
                if (isTyping) {
                    await lobbyRef.update({
                        typingUsers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                    
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => {
                        updateTypingStatus(false);
                    }, 3000);
                } else {
                    await lobbyRef.update({
                        typingUsers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                    });
                }
            } catch (error) {
                console.error('B≈ÇƒÖd aktualizacji pisania:', error);
            }
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentLobby) return;

            // Sprawd≈∫ rozmiar pliku (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå Plik jest za du≈ºy! Maksymalny rozmiar to 5MB.');
                return;
            }

            try {
                // Upload do Firebase Storage
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`lobbies/${currentLobby}/${Date.now()}_${file.name}`);
                const snapshot = await fileRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();

                // Dodaj wiadomo≈õƒá z obrazkiem
                const lobbyRef = db.collection('lobbies').doc(currentLobby);
                const lobbyDoc = await lobbyRef.get();
                
                if (lobbyDoc.exists) {
                    const messages = lobbyDoc.data().messages || [];
                    messages.push({
                        id: Date.now().toString(),
                        userId: currentUser.uid,
                        nick: userNick,
                        imageUrl: downloadURL,
                        timestamp: new Date(),
                        type: 'image'
                    });

                    await lobbyRef.update({
                        messages: messages
                    });
                }

                // Wyczy≈õƒá input
                event.target.value = '';
                
            } catch (error) {
                console.error('B≈ÇƒÖd uploadu zdjƒôcia:', error);
                alert('‚ùå B≈ÇƒÖd podczas wysy≈Çania zdjƒôcia!');
            }
        }

        function addSystemMessage(text) {
            const chatContainer = document.getElementById('lobbyChatMessages');
            if (chatContainer) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.textContent = text;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function startGame(gameType) {
            addSystemMessage(`üéÆ Rozpoczyna siƒô gra: ${gameType}`);
            // Tutaj mo≈ºna dodaƒá logikƒô gier
            alert(`Gra ${gameType} wkr√≥tce bƒôdzie dostƒôpna!`);
        }

        async function leaveLobby() {
            if (lobbyListener) {
                lobbyListener();
                lobbyListener = null;
            }

            if (currentLobby && currentUser) {
                try {
                    const lobbyRef = db.collection('lobbies').doc(currentLobby);
                    const lobbyDoc = await lobbyRef.get();
                    
                    if (lobbyDoc.exists) {
                        const lobbyData = lobbyDoc.data();
                        const updatedUsers = lobbyData.users.filter(user => user.uid !== currentUser.uid);
                        
                        if (updatedUsers.length === 0) {
                            // Usu≈Ñ lobby je≈õli nie ma ju≈º u≈ºytkownik√≥w
                            await lobbyRef.delete();
                        } else {
                            // Usu≈Ñ tylko tego u≈ºytkownika
                            await lobbyRef.update({
                                users: updatedUsers,
                                typingUsers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                            });
                            
                            // Dodaj wiadomo≈õƒá o opuszczeniu
                            const messages = lobbyData.messages || [];
                            messages.push({
                                id: Date.now().toString(),
                                userId: 'system',
                                nick: 'System',
                                text: `üö™ ${userNick} opu≈õci≈Ç czat`,
                                timestamp: new Date(),
                                type: 'system'
                            });
                            
                            await lobbyRef.update({
                                messages: messages
                            });
                        }
                    }
                } catch (error) {
                    console.error('B≈ÇƒÖd opuszczania lobby:', error);
                }
            }

            currentLobby = null;
            userNick = '';
            showScreen('screenMain');
            
            // Reset UI
            document.getElementById('lobbyCreated').style.display = 'none';
            document.getElementById('createLobbyBtn').style.display = 'block';
            document.getElementById('nickInput').style.display = 'block';
            document.getElementById('nickInput').value = '';
            document.getElementById('joinNickInput').value = '';
            document.getElementById('lobbyCodeInput').value = '';
            document.getElementById('lobbyMessageInput').value = '';
            cancelReply();
        }

        console.log('üöÄ LogoLobby za≈Çadowany! Wszystko gotowe!');
    </script>
</body>
</html>
